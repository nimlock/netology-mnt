# Домашнее задание к занятию "08.01 Введение в Ansible"

## Модуль 8. Система управления конфигурациями

### Студент: Иван Жиляев

## Подготовка к выполнению

>1. Установите ansible версии 2.10 или выше.

Установил версию 2.10.5 через pip3:

```
sudo pip3 install ansible
```

>2. Создайте свой собственный публичный репозиторий на github с произвольным именем.

Был создан текущий репозиторий для заданий этого курса.

>3. Скачайте [playbook](./playbook/) из репозитория с домашним заданием и перенесите его в свой репозиторий.

Каталог [playbook](./playbook/) скопирован.

## Основная часть

>1. Попробуйте запустить playbook на окружении из `test.yml`, зафиксируйте какое значение имеет факт `some_fact` для указанного хоста при выполнении playbook'a.

Для удобства перейдём в каталог `playbook` и запустим playbook на нужном окружении командой:

```
ansible-playbook -i inventory/test.yml -v site.yml
```

Из вывода видно, что факт `some_fact` имеет значение __`12`__.

>2. Найдите файл с переменными (group_vars) в котором задаётся найденное в первом пункте значение и поменяйте его на `all default fact`.

Так как хост `localhost`, на котором был запущен playbook, не принадлежит ни к одной из перечисленных в каталоге `group_vars` групп, то логично, что значение переменной было взято из файла [`./playbook/group_vars/all/examp.yml`](./playbook/group_vars/all/examp.yml). Заменим значение переменной в этом файле на требуемое `all default fact`.  
Повторный запуск playbook'a подтверждает верность рассуждений - переменная поменяла значение в выводе.

>3. Воспользуйтесь подготовленным (используется `docker`) или создайте собственное окружение для проведения дальнейших испытаний.

Не понял где брать подготовленное окружение, так что создал свой [docker-compose.yml](./docker-compose.yml). Для поднятия инфраструктуры достаточно выполнить команду:

```
docker-compose up -d
```

>4. Проведите запуск playbook на окружении из `prod.yml`. Зафиксируйте полученные значения `some_fact` для каждого из `managed host`.

Запустим playbook командой:

```
ansible-playbook -i inventory/prod.yml -v site.yml
```

В выводе наблюдаем такие значения переменной:

```
TASK [Print fact] ********************************************
ok: [centos7] => {
    "msg": "el"
}
ok: [ubuntu] => {
    "msg": "deb"
}
```

>5. Добавьте факты в `group_vars` каждой из групп хостов так, чтобы для `some_fact` получились следующие значения: для `deb` - 'deb default fact', для `el` - 'el default fact'.

Файлы с переменными отредактировал.

>6.  Повторите запуск playbook на окружении `prod.yml`. Убедитесь, что выдаются корректные значения для всех хостов.

Повторный запуск на оружении `prod.yml` дал следующий вывод:

```
TASK [Print fact] ********************************************
ok: [centos7] => {
    "msg": "el default fact"
}
ok: [ubuntu] => {
    "msg": "deb default fact"
}
```

>7. При помощи `ansible-vault` зашифруйте факты в `group_vars/deb` и `group_vars/el` с паролем `netology`.

Зашифруем содержимое файлов с переменными командой:

```
ansible-vault encrypt --ask-vault-password group_vars/deb/* group_vars/el/*
```

>8. Запустите playbook на окружении `prod.yml`. При запуске `ansible` должен запросить у вас пароль. Убедитесь в работоспособности.

Для возможности ввода пароля от зашифрованных файлов с переменными дополним команду запуска playbook'a:

```
ansible-playbook -i inventory/prod.yml --ask-vault-password -v site.yml
```

В выводе отображаются корректные значения переменных.

>9. Посмотрите при помощи `ansible-doc` список плагинов для подключения. Выберите подходящий для работы на `control node`.

Ознакомиться со списком плагинов для подключения можно командой:

```
ansible-doc -t connection -l
```

В нашем случае работу с `control node` удобно производить через плагин `local`.

>10. В `prod.yml` добавьте новую группу хостов с именем  `local`, в ней разместите localhost с необходимым типом подключения.

Необходимую группу добавил.

>11. Запустите playbook на окружении `prod.yml`. При запуске `ansible` должен запросить у вас пароль. Убедитесь что факты `some_fact` для каждого из хостов определены из верных `group_vars`.

Запуск playbook прошёл успешно (использовалась та же команда с флагом запроса пароля от vault), вот подтверждающий вывод:

```
TASK [Print fact] ********************************************
ok: [localhost] => {
    "msg": "all default fact"
}
ok: [centos7] => {
    "msg": "el default fact"
}
ok: [ubuntu] => {
    "msg": "deb default fact"
}
```

>12. Заполните `README.md` ответами на вопросы. Сделайте `git push` в ветку `master`. В ответе отправьте ссылку на ваш открытый репозиторий с изменённым `playbook` и заполненным `README.md`.

Файл с ответами подготовлен - [`README.md`](./playbook/README.md). Изменения будут доставлены в основную ветку `main` репозитория.

## Необязательная часть

>1. При помощи `ansible-vault` расшифруйте все зашифрованные файлы с переменными.

Это можно сделать командой:

```
ansible-vault decrypt --ask-vault-password group_vars/deb/* group_vars/el/*
```

>2. Зашифруйте отдельное значение `PaSSw0rd` для переменной `some_fact` паролем `netology`. Добавьте полученное значение в `group_vars/all/exmp.yml`.

Я решил сделать так: командой `ansible-vault encrypt_string "PaSSw0rd"` получаем в терминале шифр-строку, которую переносим в файл `group_vars/all/exmp.yml` в качестве значения переменной `some_fact`. Это позволяет сохранить читаемость playbook'a в целом.

>3. Запустите `playbook`, убедитесь, что для нужных хостов применился новый `fact`.

Проверка показала, что playbook выдаёт корректный результат:

```
TASK [Print fact] ********************************************
ok: [localhost] => {
    "msg": "PaSSw0rd"
}
ok: [centos7] => {
    "msg": "el default fact"
}
ok: [ubuntu] => {
    "msg": "deb default fact"
}
```

>4. Добавьте новую группу хостов `fedora`, самостоятельно придумайте для неё переменную. В качестве образа можно использовать [этот](https://hub.docker.com/r/pycontribs/fedora).

Группу [добавил](playbook/inventory/prod.yml), в [docker-compose](docker-compose.yml) добавил контейнер с fedora, переменную [определил](playbook/group_vars/fedora/examp.yml). 

>5. Напишите скрипт на bash: автоматизируйте поднятие необходимых контейнеров, запуск ansible-playbook и остановку контейнеров.

Структура скрипта проста: запустить docker-compose, запустить ansible-playbook, остановить docker-compose.
Я считаю, что интерактивный запрос пароля и понятие "автоматизация" - вещи взаимоисключающие. Так что я изменил способ указания пароля для расшифровки ansible-vault. Это требует определения переменной окружения `ANSIBLE_VAULT_PASSWORD` с паролем до запуска скрипта.

Получившийся скрипт расположен в этом же репозитории - [bash_script.sh](bash_script.sh) и для тестового запуска можно использовать команду:

```
ANSIBLE_VAULT_PASSWORD=netology ./bash_script.sh
```

>6. Все изменения должны быть зафиксированы и отправлены в вашей личный репозиторий.

Всё зафиксировал и отправил на проверку.
